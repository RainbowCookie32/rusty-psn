name: rusty-psn Builds

on:
  - push
  - pull_request

jobs:
  build_matrix:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        feature: ["cli", "egui"]

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2.7.3
        with:
          key: ${{ matrix.feature }}-${{ matrix.os }}
          cache-on-failure: "true"

      - name: Install dependencies
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.feature == 'egui' }}
        run: |
          sudo apt update
          sudo apt-get install libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libspeechd-dev libxkbcommon-dev libssl-dev libgtk-3-dev

      - name: Build rusty-psn
        run: cargo build --release --no-default-features --features ${{ matrix.feature }}

      - name: Move binary (Linux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          mkdir result
          cp target/release/rusty-psn result

      - name: Move binary (MacOS)
        if: ${{ matrix.os == 'macos-latest' }}
        run: |
          mkdir result
          cp target/release/rusty-psn result

      - name: Move binary (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          mkdir result
          cp target/release/rusty-psn.exe result

      - name: Upload artifact (Linux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: actions/upload-artifact@v4
        with:
          name: rusty-psn-${{ matrix.feature }}-linux
          path: result

      - name: Upload artifact (MacOS)
        if: ${{ matrix.os == 'macos-latest' }}
        uses: actions/upload-artifact@v4
        with:
          name: rusty-psn-${{ matrix.feature }}-macos
          path: result

      - name: Upload artifact (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        uses: actions/upload-artifact@v4
        with:
          name: rusty-psn-${{ matrix.feature }}-windows
          path: result
          
  create_release:
    needs: build_matrix
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    steps:
      - name: rust_app_version
        id: cargo_version
        uses: dante-signal31/rust-app-version@v1.2.0
      - name: Download artifacts
        uses: actions/download-artifact@v4.1.9
        with:
          path: ./artifacts
          patters: rusty-psn*
      - name: Create release
        uses: softprops/action-gh-release@v2.2.1
        with:
          name: "v${{ steps.cargo_version.outputs.app_version }}"
          tag_name: "v${{ steps.cargo_version.outputs.app_version }}"
          files: "./artifacts/*"
          generate_release_notes: true
          make_latest: true

          
